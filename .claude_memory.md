# Claude Memory - Telegram Bot Wireframe

## üìÖ Last Updated: 2025-07-16

## üéØ Project Status: Wireframe Complete

This wireframe provides a robust and scalable foundation for building new Telegram bots using Cloudflare Workers, TypeScript, and Hono.

## üöÄ Key Features & Improvements Implemented:

1.  **Modular Architecture:**
    *   Organized `src` directory with `config`, `core`, `features`, `lib`, `middleware`, and `services`.
    *   Clear separation of concerns for better maintainability and scalability.

2.  **Environment Variable Validation:**
    *   Integrated Zod for strict validation of environment variables (`src/config/env.ts`).

3.  **Structured Logging:**
    *   Implemented a basic logger (`src/lib/logger.ts`) and a logging middleware (`src/middleware/logger.ts`).

4.  **Testing Setup:**
    *   Configured Vitest for unit and integration testing (`vitest.config.ts`).
    *   Included a sample test file (`src/__tests__/bot.test.ts`).

5.  **Code Quality Tooling:**
    *   Added ESLint (`eslint.config.js`) and Prettier (`.prettierrc`) for consistent code style and quality.

6.  **Database Integration (D1):**
    *   Provided a basic D1 database client (`src/lib/db.ts`).
    *   Included a sample user service (`src/services/user-service.ts`).
    *   Added a sample database migration (`migrations/0001_create_users_table.sql`).

7.  **Error Monitoring (Sentry):**
    *   Integrated Sentry for error tracking (`src/config/sentry.ts`).
    *   Updated `package.json` and `src/config/env.ts` for Sentry dependency and configuration.

8.  **CI/CD Automation:**
    *   Included a basic GitHub Actions workflow for automated testing and deployment (`.github/workflows/deploy.yml`).

9.  **Security (Rate Limiting):**
    *   Implemented a basic rate-limiting middleware (`src/middleware/rate-limiter.ts`) and applied it to the webhook endpoint.

10. **Scheduled Tasks:**
    *   Implemented a handler for cron-based scheduled tasks (`src/core/scheduled-handler.ts`) and configured a sample trigger in `wrangler.toml`.

11. **Advanced User State/Session Management:**
    *   Implemented a `SessionService` (`src/services/session-service.ts`) using Cloudflare KV for managing conversational state.
    *   Updated `wrangler.toml` and `src/config/env.ts` to include KV namespace binding.

12. **Granular Input Validation:**
    *   Defined Zod schemas for Telegram API types (`src/lib/telegram-types.ts`) and integrated validation into `src/index.ts`.

13. **Structured External API Integration (Gemini Flash):**
    *   Created a `GeminiService` (`src/services/gemini-service.ts`) for interacting with Google Gemini Flash API, ensuring `gemini-2.5-flash` model usage.
    *   Updated `package.json` and `src/config/env.ts` for Gemini dependency and API key.

14. **Health Checks:**
    *   Implemented a dedicated `/health` endpoint (`src/core/health-handler.ts`) for monitoring service status and dependencies.

15. **Internationalization (i18n):**
    *   Provided a basic i18n setup (`src/lib/i18n.ts`) for multi-language support in bot messages.

16. **Enhanced Error Handling:**
    *   Implemented custom error classes (`src/lib/errors.ts`) and a centralized error handling middleware (`src/middleware/error-handler.ts`) for more robust and granular error management.

17. **Advanced Bot Features Example:**
    *   Included an example of using inline keyboards and handling callback queries in `src/core/bot.ts`, demonstrating more interactive bot capabilities.

18. **Multi-Environment Deployment:**
    *   Configured `wrangler.toml` to support distinct `staging` and `production` environments, allowing for safer deployments.

19. **Telegram Stars Integration:**
    *   Added D1 migrations for `telegram_payments` and `pending_invoices` tables (`migrations/0002_add_telegram_stars_tables.sql`).
    *   Implemented `PaymentRepository` (`src/domain/payments/repository.ts`) for database interactions.
    *   Created `TelegramStarsService` (`src/domain/services/telegram-stars.service.ts`) for core payment logic.
    *   Created `StarsService` (`src/services/stars.service.ts`) for managing player star balances.
    *   Implemented `handlePreCheckoutQuery` and `handleSuccessfulPayment` handlers (`src/adapters/telegram/handlers/paymentHandler.ts`).
    *   Integrated payment handlers and a sample payment initiation command (`/buy_message`) into `src/core/bot.ts`.
    *   Updated `src/config/env.ts` to include `DB` binding and `src/services/user-service.ts` and `migrations/0001_create_users_table.sql` to include `stars_balance`.

20. **Robust Telegram Adapter:**
    *   Introduced `TelegramAdapter` (`src/core/telegram-adapter.ts`) to encapsulate bot initialization, middleware setup, and update handling.
    *   Implemented duplicate update detection and prevention logic.
    *   Enhanced Sentry integration with user context management (`setUserContext`, `clearUserContext`).
    *   Modularized command and callback registration into `src/adapters/telegram/commands/index.ts` and `src/adapters/telegram/callbacks/index.ts`.

21. **Telegram Text Formatting Utilities:**
    *   Added `src/lib/telegram-formatter.ts` with functions for safe Markdown v2 formatting, code escaping, and other text manipulation for Telegram messages.

22. **Content Censoring Utility:**
    *   Added `src/lib/censor.ts` with functions for detecting and censoring obscene language.

23. **Fixes and Refinements:**
    *   Corrected `api: RawApi` typing in `MyContext` and ensured `bot.api` is attached in middleware.
    *   Ensured `bot` instance is correctly passed to `setupCommands` and `setupCallbacks`.
    *   Added comments for `provider_token` in `TelegramStarsService` and `escapeMarkdown` usage in `formatMessage`.

## üìù Next Steps for a New Project:

1.  **Copy the Wireframe:** Duplicate the `wireframe` directory to start your new project.
2.  **Install Dependencies:** Run `npm install` in your new project directory.
3.  **Configure `wrangler.toml`:** Update worker name, and configure D1/KV bindings if needed, and set up cron triggers.
4.  **Set Environment Variables:** Define and set `TELEGRAM_BOT_TOKEN`, `SENTRY_DSN` (optional), `GEMINI_API_KEY`, and `ENVIRONMENT` in `.dev.vars` and as Cloudflare secrets.
5.  **Set up GitHub Secrets:** For CI/CD, add `CLOUDFLARE_API_TOKEN` and `CLOUDFLARE_ACCOUNT_ID` to your GitHub repository secrets.
6.  **Develop Features:** Start building your bot's specific features within the `src/adapters/telegram/commands/` and `src/adapters/telegram/callbacks/` directories, and place your business logic in the `src/services` directory.
7.  **Deploy:** Use `npm run deploy` to deploy to Cloudflare Workers.
8.  **Set Webhook:** Configure the Telegram webhook to point to your deployed worker URL.

## üîó Relevant Files:

- `README.md`
- `GEMINI.md`
- `CLAUDE.md`
- `package.json`
- `wrangler.toml`
- `tsconfig.json`
- `vitest.config.ts`
- `eslint.config.js`
- `.prettierrc`
- `src/index.ts`
- `src/config/env.ts`
- `src/config/sentry.ts`
- `src/core/bot.ts`
- `src/core/scheduled-handler.ts`
- `src/core/health-handler.ts`
- `src/core/telegram-adapter.ts`
- `src/lib/logger.ts`
- `src/lib/db.ts`
- `src/lib/telegram-types.ts`
- `src/lib/i18n.ts`
- `src/lib/errors.ts`
- `src/lib/telegram-formatter.ts`
- `src/lib/censor.ts`
- `src/middleware/logger.ts`
- `src/middleware/rate-limiter.ts`
- `src/middleware/error-handler.ts`
- `src/services/user-service.ts`
- `src/services/session-service.ts`
- `src/services/gemini-service.ts`
- `src/services/stars.service.ts`
- `src/domain/payments/repository.ts`
- `src/domain/services/telegram-stars.service.ts`
- `src/adapters/telegram/handlers/paymentHandler.ts`
- `src/adapters/telegram/commands/index.ts`
- `src/adapters/telegram/callbacks/index.ts`
- `src/__tests__/bot.test.ts`
- `migrations/0001_create_users_table.sql`
- `migrations/0002_add_telegram_stars_tables.sql`
- `.github/workflows/deploy.yml`
